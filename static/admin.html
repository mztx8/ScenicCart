<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>景区共享观光车 - 管理后台</title>
    <!-- 引入Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Font Awesome图标 -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            background-color: #2c3e50;
            padding-top: 20px;
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .sidebar.collapsed {
            transform: translateX(-250px);
        }
        .sidebar a {
            display: block;
            color: #ecf0f1;
            padding: 15px 20px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .sidebar a:hover {
            background-color: #34495e;
        }
        .sidebar a.active {
            background-color: #3498db;
        }
        .content {
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        .sidebar.collapsed + .content {
            margin-left: 0;
        }
        .toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background-color: #2c3e50;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: left 0.3s ease;
        }
        .sidebar.collapsed + .content .toggle-sidebar {
            left: 20px;
        }
        .battery-indicator {
            height: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
            overflow: hidden;
            width: 60px;
        }
        .battery-level {
            height: 100%;
            border-radius: 4px;
        }
        .battery-level.high {
            background-color: #28a745;
        }
        .battery-level.medium {
            background-color: #ffc107;
        }
        .battery-level.low {
            background-color: #dc3545;
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .stats-card {
            border-radius: 10px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .stats-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .live-indicator {
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .badge-available {
            background-color: #28a745;
        }
        .badge-rented {
            background-color: #17a2b8;
        }
        .badge-maintenance {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar" id="sidebar">
        <div class="px-4 mb-4">
            <h3 class="text-white">管理后台</h3>
            <p class="text-white-50 text-sm">景区共享观光车系统</p>
        </div>
        <a href="#" class="nav-item active" data-target="#carManagement">
            <i class="fa fa-car" aria-hidden="true"></i> 车辆管理
        </a>
        <a href="#" class="nav-item" data-target="#orderManagement">
            <i class="fa fa-file-text-o" aria-hidden="true"></i> 订单管理
        </a>
        <a href="#" class="nav-item" data-target="#userManagement">
            <i class="fa fa-users" aria-hidden="true"></i> 用户管理
        </a>
        <a href="#" class="nav-item" data-target="#statisticsReport">
            <i class="fa fa-bar-chart" aria-hidden="true"></i> 统计报表
        </a>
        <a href="index.html">
            <i class="fa fa-sign-out" aria-hidden="true"></i> 返回首页
        </a>
    </div>

    <!-- 主内容区 -->
    <div class="content">
        <!-- 侧边栏切换按钮 -->
        <button class="toggle-sidebar" id="toggleSidebar">
            <i class="fa fa-bars" aria-hidden="true"></i>
        </button>

        <!-- 顶部导航 -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-5">
            <div class="container-fluid">
                <h2 class="navbar-brand mb-0">车辆管理</h2>
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <span class="live-indicator me-2"></span>
                        <span class="text-success">实时更新中</span>
                    </div>
                    <button class="btn btn-outline-secondary" id="refreshBtn">
                        <i class="fa fa-refresh" aria-hidden="true"></i> 刷新
                    </button>
                </div>
            </div>
        </nav>

        <!-- 内容区域容器 -->
        <div id="content-container">
            <!-- 车辆管理内容 -->
            <div id="carManagement" class="content-section">
                <!-- 统计卡片 -->
                <div class="row mb-5">
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-car stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="totalCars">--</h3>
                                <p class="card-text">总车辆数</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-check-circle stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="availableCars">--</h3>
                                <p class="card-text">可租车辆</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-hourglass-half stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="rentedCars">--</h3>
                                <p class="card-text">已租车辆</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-danger text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-wrench stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="maintenanceCars">--</h3>
                                <p class="card-text">维修车辆</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 搜索和筛选 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="搜索车辆编号、名称或车牌" id="searchInput">
                            <button class="btn btn-primary" type="button" id="searchBtn">
                                <i class="fa fa-search" aria-hidden="true"></i> 搜索
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="btn-group" data-filter-type="car-status">
                            <button class="btn btn-outline-primary active" data-filter="all">全部</button>
                            <button class="btn btn-outline-primary" data-filter="available">可租</button>
                            <button class="btn btn-outline-primary" data-filter="rented">已租</button>
                            <button class="btn btn-outline-primary" data-filter="maintenance">维修中</button>
                        </div>
                    </div>
                </div>

                <!-- 车辆列表表格 -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <table id="carsTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>编号</th>
                                    <th>车辆名称</th>
                                    <th>车牌号码</th>
                                    <th>状态</th>
                                    <th>电量</th>
                                    <th>更新时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 表格内容将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 订单管理内容 -->
            <div id="orderManagement" class="content-section" style="display: none;">
                <!-- 订单统计卡片 -->
                <div class="row mb-5">
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-file-text-o stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="totalOrders">--</h3>
                                <p class="card-text">总订单数</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-money stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="totalRevenue">--</h3>
                                <p class="card-text">总交易额</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-clock-o stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="activeOrders">--</h3>
                                <p class="card-text">进行中订单</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-warning text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-users stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="activeUsers">--</h3>
                                <p class="card-text">活跃用户</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 搜索和筛选 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="搜索订单号、用户ID或车辆ID" id="ordersSearchInput">
                            <button class="btn btn-primary" type="button" id="ordersSearchBtn">
                                <i class="fa fa-search" aria-hidden="true"></i> 搜索
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="btn-group" data-filter-type="order-status">
                            <button class="btn btn-outline-primary active" data-filter="all">全部</button>
                            <button class="btn btn-outline-primary" data-filter="ongoing">进行中</button>
                            <button class="btn btn-outline-primary" data-filter="completed">已完成</button>
                            <button class="btn btn-outline-primary" data-filter="canceled">已取消</button>
                        </div>
                    </div>
                </div>

                <!-- 订单列表表格 -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <table id="ordersTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>订单ID</th>
                                    <th>用户ID</th>
                                    <th>车辆ID</th>
                                    <th>车辆名称</th>
                                    <th>开始时间</th>
                                    <th>结束时间</th>
                                    <th>费用(元)</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 表格内容将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 用户管理内容 -->
            <div id="userManagement" class="content-section" style="display: none;">
                <!-- 用户统计卡片 -->
                <div class="row mb-5">
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-users stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="totalUsers">--</h3>
                                <p class="card-text">总用户数</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-user stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="regularUsers">--</h3>
                                <p class="card-text">普通用户</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-wrench stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="maintenanceUsers">--</h3>
                                <p class="card-text">运维人员</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-danger text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-shield stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="adminUsers">--</h3>
                                <p class="card-text">管理员</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 搜索和筛选 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="搜索用户ID、手机号或昵称" id="usersSearchInput">
                            <button class="btn btn-primary" type="button" id="usersSearchBtn">
                                <i class="fa fa-search" aria-hidden="true"></i> 搜索
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="btn-group" data-filter-type="user-role">
                            <button class="btn btn-outline-primary active" data-filter="all">全部</button>
                            <button class="btn btn-outline-primary" data-filter="tourist">普通用户</button>
                            <button class="btn btn-outline-primary" data-filter="operator">运维人员</button>
                            <button class="btn btn-outline-primary" data-filter="admin">管理员</button>
                        </div>
                    </div>
                </div>

                <!-- 用户列表表格 -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <table id="usersTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>用户ID</th>
                                    <th>手机号</th>
                                    <th>昵称</th>
                                    <th>角色</th>
                                    <th>押金(元)</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 表格内容将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 统计报表内容 -->
            <div id="statisticsReport" class="content-section" style="display: none;">
                <!-- 报表筛选器 -->
                <div class="card shadow-sm mb-5">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="reportType" class="form-label">报表类型</label>
                                <select id="reportType" class="form-select">
                                    <option value="daily">日报</option>
                                    <option value="weekly">周报</option>
                                    <option value="monthly">月报</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="startDate" class="form-label">开始日期</label>
                                <input type="date" id="startDate" class="form-control">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="endDate" class="form-label">结束日期</label>
                                <input type="date" id="endDate" class="form-control">
                            </div>
                            <div class="col-md-12 text-end">
                                <button class="btn btn-primary" id="generateReportBtn">
                                    <i class="fa fa-refresh" aria-hidden="true"></i> 生成报表
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 核心指标卡片 -->
                <div class="row mb-5">
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-file-text-o stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="reportTotalOrders">0</h3>
                                <p class="card-text">订单总数</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-money stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="reportTotalRevenue">0.00</h3>
                                <p class="card-text">总收入</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-users stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="reportActiveUsers">0</h3>
                                <p class="card-text">活跃用户</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 mb-4">
                        <div class="card stats-card bg-warning text-white">
                            <div class="card-body text-center">
                                <i class="fa fa-line-chart stats-icon" aria-hidden="true"></i>
                                <h3 class="card-title" id="reportAvgOrderValue">0.00</h3>
                                <p class="card-text">客单价</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="row mb-5">
                    <div class="col-md-6 mb-5">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="card-title mb-4">订单量趋势</h4>
                                <canvas id="ordersTrendChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-5">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="card-title mb-4">收入趋势</h4>
                                <canvas id="revenueTrendChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 车辆使用统计 -->
                <div class="row mb-5">
                    <div class="col-md-6 mb-5">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="card-title mb-4">车辆使用排行</h4>
                                <canvas id="carUsageChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-5">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="card-title mb-4">用户类型分布</h4>
                                <canvas id="userTypeChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入JQuery -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <!-- 引入DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script>
        // 全局变量
        let carsTable = null;
        let carsData = [];
        let webSocket = null;
        let carFilterStatus = 'all';
        let ordersTable = null;
        let ordersData = [];
        let orderFilterStatus = 'all';
        let usersTable = null;
        let usersData = [];
        let userFilterRole = 'all';
        let token = null;
        let userInfo = null;
        
        // 页面加载完成后执行
        $(document).ready(function() {
            // 检查用户登录状态和管理员权限
            checkAdminPermission();
        });
        
        // 检查管理员权限
        function checkAdminPermission() {
            // 从localStorage获取token和用户信息
            token = localStorage.getItem('token');
            userInfo = JSON.parse(localStorage.getItem('userInfo'));
            
            if (!token || !userInfo) {
                // 用户未登录
                alert('请先登录后再访问管理后台');
                window.location.href = 'index.html';
                return;
            }
            
            if (userInfo.role !== 2) {
                // 不是管理员
                showToast('您没有权限访问管理后台');
                window.location.href = 'index.html';
                return;
            }
            
            // 通过验证，初始化页面
            initPage();
        }
        
        // 初始化页面
        function initPage() {
            // 初始化侧边栏切换
            // 侧边栏切换
            $('#toggleSidebar').click(function() {
                $('#sidebar').toggleClass('collapsed');
            });
            
            // 导航菜单切换
            $('.nav-item').click(function() {
                // 移除所有菜单项的活跃状态
                $('.nav-item').removeClass('active');
                // 添加当前菜单项的活跃状态
                $(this).addClass('active');
                
                // 更新顶部导航栏标题
                const titleText = $(this).text().trim();
                $('.navbar-brand').text(titleText);
                
                // 隐藏所有内容区域
                $('.content-section').hide();
                
                // 显示对应的内容区域
                const targetId = $(this).data('target');
                $(targetId).show();
                
                // 初始化对应的数据加载
                if (targetId === '#carManagement') {
                    loadCars();
                    initWebSocket();
                } else if (targetId === '#orderManagement') {
                    loadOrders();
                } else if (targetId === '#userManagement') {
                    loadUsers();
                } else if (targetId === '#statisticsReport') {
                    generateReport();
                }
            });
            
            // 初始化表格
            initTables();
            
            // 加载车辆数据
            loadCars();
            
            // 初始化WebSocket连接
            initWebSocket();
            
            // 绑定搜索按钮事件
            $('#searchBtn').click(function() {
                applyFilter('car');
            });
            
            // 绑定搜索框回车事件
            $('#searchInput').keypress(function(e) {
                if (e.which === 13) {
                    applyFilter('car');
                }
            });
            
            // 绑定订单搜索按钮事件
            $('#orderSearchBtn').click(function() {
                applyFilter('order');
            });
            
            // 绑定订单搜索框回车事件
            $('#orderSearchInput').keypress(function(e) {
                if (e.which === 13) {
                    applyFilter('order');
                }
            });
            
            // 绑定用户搜索按钮事件
            $('#userSearchBtn').click(function() {
                applyFilter('user');
            });
            
            // 绑定用户搜索框回车事件
            $('#userSearchInput').keypress(function(e) {
                if (e.which === 13) {
                    applyFilter('user');
                }
            });
            
            // 绑定筛选按钮事件
            $('.btn-group button').click(function() {
                const filterType = $(this).closest('.btn-group').data('filter-type');
                $(this).closest('.btn-group').find('button').removeClass('active');
                $(this).addClass('active');
                
                if (filterType === 'car-status') {
                    carFilterStatus = $(this).data('filter');
                    applyFilter('car');
                } else if (filterType === 'order-status') {
                    orderFilterStatus = $(this).data('filter');
                    applyFilter('order');
                } else if (filterType === 'user-role') {
                    userFilterRole = $(this).data('filter');
                    applyFilter('user');
                }
            });
            
            // 绑定刷新按钮事件
            $('#refreshBtn').click(function() {
                loadCars();
            });
            
            // 绑定订单刷新按钮事件
            $('#orderRefreshBtn').click(function() {
                loadOrders();
            });
            
            // 绑定用户刷新按钮事件
            $('#userRefreshBtn').click(function() {
                loadUsers();
            });
            
            // 绑定生成报表按钮事件
            $('#generateReportBtn').click(function() {
                generateReport();
            })
        }
        
        // 显示提示消息
        function showToast(message) {
            const toast = $('<div/>', {
                class: 'toast position-fixed bottom-3 right-3 bg-dark text-white p-3 rounded shadow-lg',
                text: message
            }).appendTo('body');
            
            setTimeout(() => {
                toast.addClass('opacity-0 transition-opacity duration-300');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
        
        // 初始化所有表格
        function initTables() {
            // 初始化车辆表格
            initCarsTable();
            // 初始化订单表格
            initOrdersTable();
            // 初始化用户表格
            initUsersTable();
        }
        
        // 初始化车辆表格
        function initCarsTable() {
            carsTable = $('#carsTable').DataTable({
                responsive: true,
                autoWidth: false,
                columns: [
                    { data: 'id' },
                    { data: 'name' },
                    { data: 'plate' },
                    { 
                        data: 'status',
                        render: function(data) {
                            if (data === 0) {
                                return '<span class="badge badge-available">可租</span>';
                            } else if (data === 1) {
                                return '<span class="badge badge-rented">已租</span>';
                            } else {
                                return '<span class="badge badge-maintenance">维修中</span>';
                            }
                        }
                    },
                    { 
                        data: 'battery',
                        render: function(data) {
                            let batteryClass = 'high';
                            if (data < 30) {
                                batteryClass = 'low';
                            } else if (data < 70) {
                                batteryClass = 'medium';
                            }
                            
                            return `
                                <div class="d-flex items-center">
                                    <div class="battery-indicator mr-2">
                                        <div class="battery-level ${batteryClass}" style="width: ${data}%">
                                        </div>
                                    </div>
                                    <span>${data}%</span>
                                </div>
                            `;
                        }
                    },
                    { 
                        data: 'updated_at',
                        render: function(data) {
                            return formatDateTime(data);
                        }
                    },
                    { 
                        data: 'id',
                        render: function(data, type, row) {
                            let actions = `
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-primary edit-btn" data-id="${data}">
                                        <i class="fa fa-pencil" aria-hidden="true"></i> 编辑
                                    </button>
                            `;
                            
                            // 根据车辆状态显示不同的操作按钮
                            if (row.status === 0) {
                                actions += `
                                    <button class="btn btn-sm btn-warning maintenance-btn" data-id="${data}">
                                        <i class="fa fa-wrench" aria-hidden="true"></i> 维修
                                    </button>
                                `;
                            } else if (row.status === 2) {
                                actions += `
                                    <button class="btn btn-sm btn-success available-btn" data-id="${data}">
                                        <i class="fa fa-check" aria-hidden="true"></i> 可用
                                    </button>
                                `;
                            }
                            
                            actions += `
                                </div>
                            `;
                            
                            return actions;
                        }
                    }
                ],
                language: {
                    "sProcessing": "处理中...",
                    "sLengthMenu": "显示 _MENU_ 条记录",
                    "sZeroRecords": "没有匹配的记录",
                    "sInfo": "显示第 _START_ 至 _END_ 条记录，共 _TOTAL_ 条",
                    "sInfoEmpty": "显示第 0 至 0 条记录，共 0 条",
                    "sInfoFiltered": "(由 _MAX_ 条记录过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    }
                }
            });
            
            // 绑定表格内按钮事件（使用委托方式）
            $('#carsTable tbody').on('click', '.edit-btn', function() {
                const carId = $(this).data('id');
                editCar(carId);
            });
            
            $('#carsTable tbody').on('click', '.maintenance-btn', function() {
                const carId = $(this).data('id');
                setCarMaintenance(carId);
            });
            
            $('#carsTable tbody').on('click', '.available-btn', function() {
                const carId = $(this).data('id');
                setCarAvailable(carId);
            });
        }
        
        // 初始化订单表格
        function initOrdersTable() {
            ordersTable = $('#ordersTable').DataTable({
                responsive: true,
                autoWidth: false,
                columns: [
                    { data: 'id' },
                    { data: 'user_id' },
                    { data: 'car_id' },
                    { data: 'start_time',
                      render: function(data) {
                          return formatDateTime(data);
                      }
                    },
                    { data: 'end_time',
                      render: function(data) {
                          return data ? formatDateTime(data) : '进行中';
                      }
                    },
                    { 
                        data: 'status',
                        render: function(data) {
                            if (data === 0) {
                                return '<span class="badge badge-primary">进行中</span>';
                            } else if (data === 1) {
                                return '<span class="badge badge-success">已完成</span>';
                            } else if (data === 2) {
                                return '<span class="badge badge-danger">已取消</span>';
                            }
                        }
                    },
                    { data: 'total_fee' },
                    { 
                        data: 'id',
                        render: function(data, type, row) {
                            let actions = `
                                <div class="btn-group">
                            `;
                            
                            // 根据订单状态显示不同的操作按钮
                            if (row.status === 0) {
                                actions += `
                                    <button class="btn btn-sm btn-success complete-btn" data-id="${data}">
                                        <i class="fa fa-check" aria-hidden="true"></i> 完成
                                    </button>
                                    <button class="btn btn-sm btn-danger cancel-btn" data-id="${data}">
                                        <i class="fa fa-times" aria-hidden="true"></i> 取消
                                    </button>
                                `;
                            }
                            
                            actions += `
                                </div>
                            `;
                            
                            return actions;
                        }
                    }
                ],
                language: {
                    "sProcessing": "处理中...",
                    "sLengthMenu": "显示 _MENU_ 条记录",
                    "sZeroRecords": "没有匹配的记录",
                    "sInfo": "显示第 _START_ 至 _END_ 条记录，共 _TOTAL_ 条",
                    "sInfoEmpty": "显示第 0 至 0 条记录，共 0 条",
                    "sInfoFiltered": "(由 _MAX_ 条记录过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    }
                }
            });
            
            // 绑定订单表格内按钮事件
            $('#ordersTable tbody').on('click', '.complete-btn', function() {
                const orderId = $(this).data('id');
                completeOrder(orderId);
            });
            
            $('#ordersTable tbody').on('click', '.cancel-btn', function() {
                const orderId = $(this).data('id');
                cancelOrder(orderId);
            });
        }
        
        // 初始化用户表格
        function initUsersTable() {
            usersTable = $('#usersTable').DataTable({
                responsive: true,
                autoWidth: false,
                columns: [
                    { data: 'id' },
                    { data: 'phone' },
                    { data: 'nickname' },
                    { 
                        data: 'role',
                        render: function(data) {
                            if (data === 0) {
                                return '<span class="badge badge-primary">游客</span>';
                            } else if (data === 1) {
                                return '<span class="badge badge-warning">运维</span>';
                            } else if (data === 2) {
                                return '<span class="badge badge-danger">管理员</span>';
                            }
                        }
                    },
                    { data: 'deposit' },
                    { 
                        data: 'id',
                        render: function(data, type, row) {
                            let actions = `
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-primary edit-role-btn" data-id="${data}" data-role="${row.role}">
                                        <i class="fa fa-pencil" aria-hidden="true"></i> 修改角色
                                    </button>
                                    <button class="btn btn-sm btn-warning deposit-btn" data-id="${data}" data-deposit="${row.deposit}">
                                        <i class="fa fa-money" aria-hidden="true"></i> 押金
                                    </button>
                            `;
                            
                            actions += `
                                </div>
                            `;
                            
                            return actions;
                        }
                    }
                ],
                language: {
                    "sProcessing": "处理中...",
                    "sLengthMenu": "显示 _MENU_ 条记录",
                    "sZeroRecords": "没有匹配的记录",
                    "sInfo": "显示第 _START_ 至 _END_ 条记录，共 _TOTAL_ 条",
                    "sInfoEmpty": "显示第 0 至 0 条记录，共 0 条",
                    "sInfoFiltered": "(由 _MAX_ 条记录过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    }
                }
            });
            
            // 绑定用户表格内按钮事件
            $('#usersTable tbody').on('click', '.edit-role-btn', function() {
                const userId = $(this).data('id');
                const currentRole = $(this).data('role');
                editUserRole(userId, currentRole);
            });
            
            $('#usersTable tbody').on('click', '.deposit-btn', function() {
                const userId = $(this).data('id');
                const currentDeposit = $(this).data('deposit');
                updateDeposit(userId, currentDeposit);
            });
        }
        
        // 加载车辆数据
        function loadCars() {
            $.ajax({
                url: '/cars',
                type: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                dataType: 'json',
                success: function(cars) {
                    carsData = cars;
                    updateCarsTable();
                    updateCarStats();
                },
                error: function() {
                    showToast('加载车辆数据失败');
                }
            });
        }
        
        // 加载订单数据
        function loadOrders() {
            $.ajax({
                url: '/orders',
                type: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                dataType: 'json',
                success: function(orders) {
                    ordersData = orders;
                    updateOrdersTable();
                    updateOrderStats();
                },
                error: function() {
                    showToast('加载订单数据失败');
                }
            });
        }
        
        // 加载用户数据
        function loadUsers() {
            $.ajax({
                url: '/users',
                type: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                dataType: 'json',
                success: function(users) {
                    usersData = users;
                    updateUsersTable();
                    updateUserStats();
                },
                error: function() {
                    showToast('加载用户数据失败');
                }
            });
        }
        
        // 更新车辆表格数据
        function updateCarsTable() {
            if (carsTable) {
                carsTable.clear().rows.add(carsData).draw();
            }
        }
        
        // 更新订单表格数据
        function updateOrdersTable() {
            if (ordersTable) {
                ordersTable.clear().rows.add(ordersData).draw();
            }
        }
        
        // 更新用户表格数据
        function updateUsersTable() {
            if (usersTable) {
                usersTable.clear().rows.add(usersData).draw();
            }
        }
        
        // 更新车辆统计信息
        function updateCarStats() {
            const total = carsData.length;
            const available = carsData.filter(car => car.status === 0).length;
            const rented = carsData.filter(car => car.status === 1).length;
            const maintenance = carsData.filter(car => car.status === 2).length;
            
            $('#totalCars').text(total);
            $('#availableCars').text(available);
            $('#rentedCars').text(rented);
            $('#maintenanceCars').text(maintenance);
        }
        
        // 更新订单统计信息
        function updateOrderStats() {
            const total = ordersData.length;
            const ongoing = ordersData.filter(order => order.status === 0).length;
            const completed = ordersData.filter(order => order.status === 1).length;
            const canceled = ordersData.filter(order => order.status === 2).length;
            
            $('#totalOrders').text(total);
            $('#ongoingOrders').text(ongoing);
            $('#completedOrders').text(completed);
            $('#canceledOrders').text(canceled);
        }
        
        // 更新用户统计信息
        function updateUserStats() {
            const total = usersData.length;
            const tourists = usersData.filter(user => user.role === 0).length;
            const operators = usersData.filter(user => user.role === 1).length;
            const admins = usersData.filter(user => user.role === 2).length;
            
            $('#totalUsers').text(total);
            $('#touristUsers').text(tourists);
            $('#operatorUsers').text(operators);
            $('#adminUsers').text(admins);
        }
        
        // 应用筛选
        function applyFilter(type) {
            if (type === 'car') {
                const searchTerm = $('#searchInput').val().toLowerCase();
                
                let filteredData = carsData.filter(car => {
                    // 搜索过滤
                    const matchesSearch = 
                        car.id.toString().includes(searchTerm) ||
                        car.name.toLowerCase().includes(searchTerm) ||
                        car.plate.toLowerCase().includes(searchTerm);
                    
                    // 状态过滤
                    const matchesFilter = 
                        carFilterStatus === 'all' ||
                        (carFilterStatus === 'available' && car.status === 0) ||
                        (carFilterStatus === 'rented' && car.status === 1) ||
                        (carFilterStatus === 'maintenance' && car.status === 2);
                    
                    return matchesSearch && matchesFilter;
                });
                
                // 更新表格
                if (carsTable) {
                    carsTable.clear().rows.add(filteredData).draw();
                }
            } else if (type === 'order') {
                const searchTerm = $('#orderSearchInput').val().toLowerCase();
                
                let filteredData = ordersData.filter(order => {
                    // 搜索过滤
                    const matchesSearch = 
                        order.id.toString().includes(searchTerm) ||
                        order.user_id.toString().includes(searchTerm) ||
                        order.car_id.toString().includes(searchTerm);
                    
                    // 状态过滤
                    const matchesFilter = 
                        orderFilterStatus === 'all' ||
                        (orderFilterStatus === 'ongoing' && order.status === 0) ||
                        (orderFilterStatus === 'completed' && order.status === 1) ||
                        (orderFilterStatus === 'canceled' && order.status === 2);
                    
                    return matchesSearch && matchesFilter;
                });
                
                // 更新表格
                if (ordersTable) {
                    ordersTable.clear().rows.add(filteredData).draw();
                }
            } else if (type === 'user') {
                const searchTerm = $('#userSearchInput').val().toLowerCase();
                
                let filteredData = usersData.filter(user => {
                    // 搜索过滤
                    const matchesSearch = 
                        user.id.toString().includes(searchTerm) ||
                        user.phone.includes(searchTerm) ||
                        (user.nickname && user.nickname.toLowerCase().includes(searchTerm));
                    
                    // 角色过滤
                    const matchesFilter = 
                        userFilterRole === 'all' ||
                        (userFilterRole === 'tourist' && user.role === 0) ||
                        (userFilterRole === 'operator' && user.role === 1) ||
                        (userFilterRole === 'admin' && user.role === 2);
                    
                    return matchesSearch && matchesFilter;
                });
                
                // 更新表格
                if (usersTable) {
                    usersTable.clear().rows.add(filteredData).draw();
                }
            }
        }
        
        // 初始化WebSocket连接
        function initWebSocket() {
            // 构建WebSocket URL
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/status`;
            
            // 创建WebSocket连接
            webSocket = new WebSocket(wsUrl);
            
            // 连接建立时
            webSocket.onopen = function(event) {
                console.log('WebSocket连接已建立');
            };
            
            // 接收消息时
            webSocket.onmessage = function(event) {
                try {
                    const statusUpdates = JSON.parse(event.data);
                    updateCarStatus(statusUpdates);
                } catch (e) {
                    console.error('解析WebSocket消息失败:', e);
                }
            };
            
            // 连接关闭时
            webSocket.onclose = function(event) {
                console.log('WebSocket连接已关闭');
                // 尝试重连
                setTimeout(initWebSocket, 3000);
            };
            
            // 连接错误时
            webSocket.onerror = function(error) {
                console.error('WebSocket错误:', error);
            };
        }
        
        // 更新车辆状态
        function updateCarStatus(statusUpdates) {
            statusUpdates.forEach(update => {
                const carIndex = carsData.findIndex(car => car.id === update.car_id);
                if (carIndex !== -1) {
                    // 更新车辆状态和电量
                    carsData[carIndex].status = update.status;
                    carsData[carIndex].battery = update.battery;
                    carsData[carIndex].updated_at = new Date().toISOString();
                }
            });
            
            // 应用筛选并更新表格
            applyFilter('car');
            updateCarStats();
        }
        
        // 编辑车辆信息（简化实现）
        function editCar(carId) {
            const car = carsData.find(car => car.id === carId);
            if (car) {
                const newName = prompt('请输入新的车辆名称:', car.name);
                if (newName && newName.trim() !== '') {
                    // 调用API更新车辆信息
                    $.ajax({
                        url: `/cars/${carId}`,
                        type: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify({ name: newName }),
                        success: function() {
                            showToast(`车辆 ${carId} 的名称已更新为: ${newName}`);
                            // 刷新数据
                            loadCars();
                        },
                        error: function() {
                            showToast('更新车辆信息失败');
                        }
                    });
                }
            }
        }
        
        // 设置车辆为维修状态
        function setCarMaintenance(carId) {
            if (confirm('确定要将此车辆设置为维修状态吗？')) {
                $.ajax({
                    url: `/cars/${carId}/status?status=2`,
                    type: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    dataType: 'json',
                    success: function() {
                        showToast('车辆已设置为维修状态');
                        loadCars();
                    },
                    error: function() {
                        showToast('操作失败，请稍后重试');
                    }
                });
            }
        }
        
        // 设置车辆为可用状态
        function setCarAvailable(carId) {
            if (confirm('确定要将此车辆设置为可用状态吗？')) {
                $.ajax({
                    url: `/cars/${carId}/status?status=0`,
                    type: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    dataType: 'json',
                    success: function() {
                        showToast('车辆已设置为可用状态');
                        loadCars();
                    },
                    error: function() {
                        showToast('操作失败，请稍后重试');
                    }
                });
            }
        }
        
        // 格式化日期时间
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // 完成订单
        function completeOrder(orderId) {
            if (confirm('确定要完成此订单吗？')) {
                $.ajax({
                    url: `/orders/${orderId}/complete`,
                    type: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    dataType: 'json',
                    success: function() {
                        showToast('订单已完成');
                        loadOrders();
                    },
                    error: function() {
                        showToast('操作失败，请稍后重试');
                    }
                });
            }
        }
        
        // 取消订单
        function cancelOrder(orderId) {
            if (confirm('确定要取消此订单吗？')) {
                $.ajax({
                    url: `/orders/${orderId}/cancel`,
                    type: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    dataType: 'json',
                    success: function() {
                        showToast('订单已取消');
                        loadOrders();
                    },
                    error: function() {
                        showToast('操作失败，请稍后重试');
                    }
                });
            }
        }
        
        // 修改用户角色
        function editUserRole(userId, currentRole) {
            let newRole = prompt('请选择新角色 (0: 游客, 1: 运维, 2: 管理员):', currentRole);
            newRole = parseInt(newRole);
            
            if (newRole !== null && [0, 1, 2].includes(newRole)) {
                $.ajax({
                    url: `/users/${userId}/role`,
                    type: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({ role: newRole }),
                    success: function() {
                        let roleName = '游客';
                        if (newRole === 1) roleName = '运维';
                        else if (newRole === 2) roleName = '管理员';
                        
                        showToast(`用户 ${userId} 的角色已更新为: ${roleName}`);
                        loadUsers();
                    },
                    error: function() {
                        showToast('更新用户角色失败');
                    }
                });
            }
        }
        
        // 更新用户押金
        function updateDeposit(userId, currentDeposit) {
            let newDeposit = prompt('请输入新的押金金额:', currentDeposit);
            newDeposit = parseFloat(newDeposit);
            
            if (newDeposit !== null && !isNaN(newDeposit) && newDeposit >= 0) {
                $.ajax({
                    url: `/users/${userId}/deposit`,
                    type: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({ deposit: newDeposit }),
                    success: function() {
                        showToast(`用户 ${userId} 的押金已更新为: ${newDeposit}`);
                        loadUsers();
                    },
                    error: function() {
                        showToast('更新用户押金失败');
                    }
                });
            }
        }
        
        // 生成报表
        function generateReport() {
            const reportType = $('#reportType').val();
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();
            
            $.ajax({
                url: '/reports',
                type: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                data: {
                    type: reportType,
                    start_date: startDate,
                    end_date: endDate
                },
                dataType: 'json',
                success: function(reportData) {
                    // 更新核心指标
                    $('#totalOrdersReport').text(reportData.total_orders || 0);
                    $('#totalRevenueReport').text(reportData.total_revenue || 0);
                    $('#activeUsersReport').text(reportData.active_users || 0);
                    $('#averageOrderValueReport').text(reportData.average_order_value ? reportData.average_order_value.toFixed(2) : 0);
                    
                    // 渲染图表
                    renderCharts(reportData);
                    showToast('报表生成成功');
                },
                error: function() {
                    showToast('生成报表失败');
                }
            });
        }
        
        // 渲染图表
        function renderCharts(reportData) {
            // 订单量趋势图
            const orderTrendCtx = document.getElementById('orderTrendChart').getContext('2d');
            if (window.orderTrendChart) {
                window.orderTrendChart.destroy();
            }
            window.orderTrendChart = new Chart(orderTrendCtx, {
                type: 'line',
                data: {
                    labels: reportData.dates || [],
                    datasets: [{
                        label: '订单数量',
                        data: reportData.daily_orders || [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '订单量趋势'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // 收入趋势图
            const revenueTrendCtx = document.getElementById('revenueTrendChart').getContext('2d');
            if (window.revenueTrendChart) {
                window.revenueTrendChart.destroy();
            }
            window.revenueTrendChart = new Chart(revenueTrendCtx, {
                type: 'line',
                data: {
                    labels: reportData.dates || [],
                    datasets: [{
                        label: '收入金额',
                        data: reportData.daily_revenue || [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '收入趋势'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // 车辆使用排行
            const carUsageCtx = document.getElementById('carUsageChart').getContext('2d');
            if (window.carUsageChart) {
                window.carUsageChart.destroy();
            }
            window.carUsageChart = new Chart(carUsageCtx, {
                type: 'bar',
                data: {
                    labels: reportData.car_names || [],
                    datasets: [{
                        label: '使用次数',
                        data: reportData.car_usage_counts || [],
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '车辆使用排行'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // 用户类型分布
            const userTypeCtx = document.getElementById('userTypeChart').getContext('2d');
            if (window.userTypeChart) {
                window.userTypeChart.destroy();
            }
            window.userTypeChart = new Chart(userTypeCtx, {
                type: 'pie',
                data: {
                    labels: ['游客', '运维', '管理员'],
                    datasets: [{
                        data: [
                            reportData.tourist_count || 0,
                            reportData.operator_count || 0,
                            reportData.admin_count || 0
                        ],
                        backgroundColor: [
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(255, 99, 132, 0.5)'
                        ],
                        borderColor: [
                            'rgb(255, 206, 86)',
                            'rgb(75, 192, 192)',
                            'rgb(255, 99, 132)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '用户类型分布'
                        }
                    }
                }
            });
        }
        
        // 页面关闭时关闭WebSocket连接
        window.addEventListener('beforeunload', function() {
            if (webSocket && webSocket.readyState === WebSocket.OPEN) {
                webSocket.close();
            }
        });
    </script>
</body>
</html>