<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>景区共享观光车 - 首页</title>
    <!-- 引入Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Font Awesome图标 -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .car-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 10px;
            overflow: hidden;
        }
        .car-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .battery-indicator {
            height: 10px;
            border-radius: 5px;
            background-color: #e9ecef;
            overflow: hidden;
        }
        .battery-level {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease, background-color 0.5s ease;
        }
        .battery-level.high {
            background-color: #28a745;
        }
        .battery-level.medium {
            background-color: #ffc107;
        }
        .battery-level.low {
            background-color: #dc3545;
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .scan-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .scan-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }
        .badge-available {
            background-color: #28a745;
        }
        .badge-rented {
            background-color: #17a2b8;
        }
        .badge-maintenance {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fa fa-car" aria-hidden="true"></i> 景区共享观光车
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="myOrdersBtn">我的订单</a>
                    </li>
                    <li class="nav-item">
                <a class="nav-link" href="admin.html">管理后台</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="loginBtn">登录</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="registerBtn">注册</a>
            </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="container mt-5 mb-20">
        <div class="mb-5 text-center">
            <h1 class="display-4">欢迎使用景区共享观光车</h1>
            <p class="text-muted">扫码租车，畅游景区</p>
        </div>

        <!-- 筛选栏 -->
        <div class="mb-4">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="搜索车辆编号或车牌" id="searchInput">
                        <button class="btn btn-primary" type="button" id="searchBtn">
                            <i class="fa fa-search" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="btn-group">
                        <button class="btn btn-outline-primary active" data-filter="all">全部</button>
                        <button class="btn btn-outline-primary" data-filter="available">可租</button>
                        <button class="btn btn-outline-primary" data-filter="rented">已租</button>
                        <button class="btn btn-outline-primary" data-filter="maintenance">维修中</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用户信息显示 -->
        <div id="userInfo" class="mb-4" style="display: none;">
          <div class="alert alert-success" role="alert">
            <span id="welcomeMessage"></span>
            <button type="button" class="btn btn-danger btn-sm float-end" id="logoutBtn">退出登录</button>
          </div>
        </div>
        
        <!-- 车辆列表 -->
        <div class="row" id="carList">
            <!-- 车辆卡片会通过JS动态生成 -->
            <div class="col-12 text-center py-10">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">加载中...</span>
                </div>
                <p class="mt-2">正在加载车辆信息...</p>
            </div>
        </div>
    </main>

    <!-- 登录模态框 -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">用户登录</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="mb-3">
                <label for="loginPhone" class="form-label">手机号</label>
                <input type="tel" class="form-control" id="loginPhone" placeholder="请输入手机号" required>
              </div>
              <div class="mb-3">
                <label for="loginPassword" class="form-label">密码</label>
                <input type="password" class="form-control" id="loginPassword" placeholder="请输入密码" required>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" class="btn btn-primary">登录</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 注册模态框 -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="registerModalLabel">用户注册</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="registerForm">
              <div class="mb-3">
                <label for="registerNickname" class="form-label">昵称</label>
                <input type="text" class="form-control" id="registerNickname" placeholder="请输入昵称" required>
              </div>
              <div class="mb-3">
                <label for="registerPhone" class="form-label">手机号</label>
                <input type="tel" class="form-control" id="registerPhone" placeholder="请输入手机号" required>
              </div>
              <div class="mb-3">
                <label for="registerPassword" class="form-label">密码</label>
                <input type="password" class="form-control" id="registerPassword" placeholder="请输入密码" required>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" class="btn btn-primary">注册</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 扫码按钮 -->
    <button class="btn btn-primary scan-btn" id="scanBtn">
        <i class="fa fa-qrcode fa-lg" aria-hidden="true"></i>
    </button>

    <!-- 引入Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入JQuery -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    
    <script>
        // 页面加载完成后执行
        $(document).ready(function() {
            // 加载车辆列表
            loadCars();
            
            // 搜索按钮点击事件
            $('#searchBtn').click(function() {
                loadCars();
            });
            
            // 搜索框回车事件
            $('#searchInput').keypress(function(e) {
                if (e.which === 13) {
                    loadCars();
                }
            });
            
            // 筛选按钮点击事件
            $('.btn-group button').click(function() {
                $('.btn-group button').removeClass('active');
                $(this).addClass('active');
                loadCars();
            });
            
            // 扫码按钮点击事件
            $('#scanBtn').click(function() {
                const isLoggedIn = localStorage.getItem('token') !== null;
                if (isLoggedIn) {
                    alert('扫码功能暂未实现，可点击车辆卡片进行租车');
                } else {
                    $('#loginModal').modal('show');
                    showToast('请先登录后再租车');
                }
            });
            
            // 我的订单按钮点击事件
            $('#myOrdersBtn').click(function() {
                const isLoggedIn = localStorage.getItem('token') !== null;
                if (isLoggedIn) {
                    loadOrders();
                } else {
                    $('#loginModal').modal('show');
                    showToast('请先登录后查看订单');
                }
            });
            
            // 登录按钮点击事件
            $('#loginBtn').click(function() {
                $('#loginModal').modal('show');
            });
            
            // 注册按钮点击事件
            $('#registerBtn').click(function() {
                $('#registerModal').modal('show');
            });
            
            // 退出登录按钮点击事件
            $('#logoutBtn').click(function() {
                localStorage.removeItem('token');
                localStorage.removeItem('userInfo');
                updateUserStatus();
                showToast('已退出登录');
            });
            
            // 登录表单提交事件
            $('#loginForm').submit(function(e) {
                e.preventDefault();
                
                const phone = $('#loginPhone').val();
                const password = $('#loginPassword').val();
                
                $.ajax({
                    url: '/users/token',
                    type: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    data: new URLSearchParams({
                        username: phone,
                        password: password
                    }).toString(),
                    success: function(data) {
                        localStorage.setItem('token', data.access_token);
                        localStorage.setItem('userInfo', JSON.stringify({
                            id: data.user_id,
                            role: data.role
                        }));
                        
                        // 获取用户详细信息
                        $.ajax({
                            url: '/users/me',
                            type: 'GET',
                            headers: {
                                'Authorization': `Bearer ${data.access_token}`
                            },
                            success: function(userData) {
                                const userInfo = JSON.parse(localStorage.getItem('userInfo'));
                                userInfo.nickname = userData.nickname;
                                userInfo.phone = userData.phone;
                                localStorage.setItem('userInfo', JSON.stringify(userInfo));
                                
                                $('#loginModal').modal('hide');
                                updateUserStatus();
                                showToast('登录成功');
                                loadCars(); // 刷新车辆列表
                            }
                        });
                    },
                    error: function() {
                        showToast('登录失败，请检查手机号和密码');
                    }
                });
            });
            
            // 注册表单提交事件
            $('#registerForm').submit(function(e) {
                e.preventDefault();
                
                const nickname = $('#registerNickname').val();
                const phone = $('#registerPhone').val();
                const password = $('#registerPassword').val();
                
                $.ajax({
                    url: '/users/register',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        nickname: nickname,
                        phone: phone,
                        password: password
                    }),
                    success: function() {
                        $('#registerModal').modal('hide');
                        showToast('注册成功，请登录');
                    },
                    error: function() {
                        showToast('注册失败，该手机号可能已被注册');
                    }
                });
            });
            
            // 检查用户登录状态
            updateUserStatus();
        });
        
        // 加载车辆列表
        function loadCars() {
            // 获取搜索关键词和筛选条件
            const searchTerm = $('#searchInput').val().toLowerCase();
            const filter = $('.btn-group button.active').data('filter');
            
            // 显示加载中
            $('#carList').html(`
                <div class="col-12 text-center py-10">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载车辆信息...</p>
                </div>
            `);
            
            // 调用API获取车辆列表
            $.ajax({
                url: '/cars',
                type: 'GET',
                dataType: 'json',
                success: function(cars) {
                    // 过滤车辆
                    const filteredCars = cars.filter(car => {
                        // 搜索过滤
                        const matchesSearch = 
                            car.name.toLowerCase().includes(searchTerm) || 
                            car.plate.toLowerCase().includes(searchTerm);
                        
                        // 状态过滤
                        const matchesFilter = 
                            filter === 'all' || 
                            (filter === 'available' && car.status === 0) ||
                            (filter === 'rented' && car.status === 1) ||
                            (filter === 'maintenance' && car.status === 2);
                        
                        return matchesSearch && matchesFilter;
                    });
                    
                    // 渲染车辆列表
                    if (filteredCars.length === 0) {
                        $('#carList').html(`
                            <div class="col-12 text-center py-10">
                                <i class="fa fa-search fa-5x text-muted" aria-hidden="true"></i>
                                <p class="mt-2 text-muted">未找到符合条件的车辆</p>
                            </div>
                        `);
                        return;
                    }
                    
                    const isLoggedIn = localStorage.getItem('token') !== null;
                    
                    let html = '';
                    filteredCars.forEach(car => {
                        // 确定电池电量样式
                        let batteryClass = 'high';
                        if (car.battery < 30) {
                            batteryClass = 'low';
                        } else if (car.battery < 70) {
                            batteryClass = 'medium';
                        }
                        
                        // 确定状态标签
                        let statusText = '可租';
                        let statusClass = 'badge-available';
                        let buttonText = '立即租车';
                        let buttonClass = 'btn-primary';
                        let buttonDisabled = '';
                        let buttonAction = `window.location.href = 'rent.html?id=${car.id}'`;
                        
                        if (car.status === 1) {
                            statusText = '已租';
                            statusClass = 'badge-rented';
                            buttonText = '车辆已租';
                            buttonClass = 'btn-secondary';
                            buttonDisabled = 'disabled';
                            buttonAction = '';
                        } else if (car.status === 2) {
                            statusText = '维修中';
                            statusClass = 'badge-maintenance';
                            buttonText = '车辆维修中';
                            buttonClass = 'btn-danger';
                            buttonDisabled = 'disabled';
                            buttonAction = '';
                        } else if (!isLoggedIn) {
                            buttonText = '请先登录';
                            buttonClass = 'btn-primary';
                            buttonDisabled = '';
                            buttonAction = "$('#loginModal').modal('show'); showToast('请先登录后再租车');";
                        }
                        
                        html += `
                        <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4">
                            <div class="card car-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between items-start mb-3">
                                        <h5 class="card-title">${car.name}</h5>
                                        <span class="badge ${statusClass} status-badge">${statusText}</span>
                                    </div>
                                    <p class="card-text text-muted mb-2">车牌: ${car.plate}</p>
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-sm">电量</span>
                                            <span class="text-sm">${car.battery}%</span>
                                        </div>
                                        <div class="battery-indicator">
                                            <div class="battery-level ${batteryClass}" style="width: ${car.battery}%"></div>
                                        </div>
                                    </div>
                                    <button class="btn ${buttonClass} w-100 mt-3 rent-btn" ${buttonDisabled} onclick="${buttonAction}">
                                        ${buttonText}
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    });
                    
                    $('#carList').html(html);
                },
                error: function() {
                    $('#carList').html(`
                        <div class="col-12 text-center py-10">
                            <i class="fa fa-exclamation-circle fa-5x text-danger" aria-hidden="true"></i>
                            <p class="mt-2 text-danger">加载车辆信息失败，请稍后重试</p>
                        </div>
                    `);
                }
            });
        }
        
        // 加载订单列表
        function loadOrders() {
            // 这里简单实现，实际应该跳转到订单页面
            alert('订单功能将在后续实现');
        }
        
        // 更新用户状态显示
        function updateUserStatus() {
            const token = localStorage.getItem('token');
            const userInfoData = JSON.parse(localStorage.getItem('userInfo'));
            
            if (token && userInfoData) {
                // 显示用户信息，隐藏登录/注册按钮
                $('#userInfo').show();
                $('#loginBtn').parent().hide();
                $('#registerBtn').parent().hide();
                $('#welcomeMessage').text(`欢迎，${userInfoData.nickname || '用户'}`);
            } else {
                // 隐藏用户信息，显示登录/注册按钮
                $('#userInfo').hide();
                $('#loginBtn').parent().show();
                $('#registerBtn').parent().show();
            }
        }
        
        // 显示提示消息
        function showToast(message) {
            const toast = $('<div/>', {
                class: 'toast position-fixed bottom-3 right-3 bg-dark text-white p-3 rounded shadow-lg',
                text: message
            }).appendTo('body');
            
            setTimeout(() => {
                toast.addClass('opacity-0 transition-opacity duration-300');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>